import React, { useMemo } from 'react';

const zakarpattiaGeoJson = {
  type: 'FeatureCollection',
  features: [
    {
      type: 'Feature',
      properties: { name: 'zakarpattia_oblast' },
      geometry: {
        type: 'MultiPolygon',
        coordinates: [
          [
            [
              [22.12, 48.43],
              [22.14, 48.53],
              [22.14, 48.575],
              [22.16, 48.61],
              [22.205, 48.64],
              [22.225, 48.64],
              [22.24, 48.665],
              [22.275, 48.68],
              [22.29, 48.695],
              [22.325, 48.705],
              [22.335, 48.73],
              [22.325, 48.74],
              [22.325, 48.77],
              [22.34, 48.79],
              [22.35, 48.79],
              [22.365, 48.805],
              [22.355, 48.825],
              [22.36, 48.865],
              [22.38, 48.895],
              [22.4, 48.9],
              [22.405, 48.94],
              [22.46, 48.995],
              [22.465, 49.01],
              [22.49, 49.02],
              [22.515, 49.015],
              [22.52, 49.02],
              [22.52, 49.035],
              [22.53, 49.04],
              [22.535, 49.09],
              [22.545, 49.1],
              [22.57, 49.115],
              [22.605, 49.115],
              [22.635, 49.1],
              [22.66, 49.07],
              [22.685, 49.06],
              [22.69, 49.07],
              [22.715, 49.075],
              [22.745, 49.065],
              [22.77, 49.075],
              [22.805, 49.055],
              [22.82, 49.055],
              [22.825, 49.045],
              [22.85, 49.04],
              [22.86, 49.025],
              [22.91, 49.025],
              [22.93, 49.005],
              [22.94, 48.965],
              [22.92, 48.945],
              [22.895, 48.945],
              [22.91, 48.92],
              [22.985, 48.89],
              [22.99, 48.855],
              [23.1, 48.885],
              [23.145, 48.87],
              [23.155, 48.85],
              [23.165, 48.85],
              [23.2, 48.81],
              [23.21, 48.78],
              [23.22, 48.785],
              [23.26, 48.78],
              [23.27, 48.795],
              [23.295, 48.795],
              [23.335, 48.775],
              [23.35, 48.79],
              [23.37, 48.79],
              [23.39, 48.775],
              [23.395, 48.76],
              [23.435, 48.745],
              [23.485, 48.74],
              [23.505, 48.755],
              [23.52, 48.755],
              [23.53, 48.745],
              [23.58, 48.745],
              [23.61, 48.725],
              [23.64, 48.725],
              [23.665, 48.69],
              [23.685, 48.685],
              [23.705, 48.66],
              [23.8, 48.66],
              [23.815, 48.645],
              [23.815, 48.6],
              [23.845, 48.6],
              [23.86, 48.575],
              [23.895, 48.575],
              [23.91, 48.585],
              [23.95, 48.56],
              [23.95, 48.545],
              [23.94, 48.535],
              [23.945, 48.505],
              [23.935, 48.485],
              [23.955, 48.48],
              [23.955, 48.49],
              [23.995, 48.525],
              [24.035, 48.525],
              [24.075, 48.545],
              [24.095, 48.545],
              [24.105, 48.555],
              [24.14, 48.55],
              [24.155, 48.53],
              [24.145, 48.51],
              [24.16, 48.49],
              [24.15, 48.455],
              [24.165, 48.445],
              [24.17, 48.4],
              [24.19, 48.395],
              [24.195, 48.385],
              [24.255, 48.375],
              [24.27, 48.42],
              [24.305, 48.42],
              [24.37, 48.395],
              [24.38, 48.365],
              [24.43, 48.35],
              [24.455, 48.32],
              [24.51, 48.285],
              [24.51, 48.26],
              [24.555, 48.24],
              [24.565, 48.225],
              [24.565, 48.205],
              [24.545, 48.195],
              [24.535, 48.16],
              [24.55, 48.14],
              [24.61, 48.105],
              [24.64, 48.075],
              [24.645, 48.035],
              [24.59, 48.005],
              [24.595, 47.995],
              [24.585, 47.985],
              [24.585, 47.965],
              [24.56, 47.94],
              [24.5, 47.93],
              [24.435, 47.95],
              [24.405, 47.935],
              [24.39, 47.905],
              [24.355, 47.895],
              [24.335, 47.895],
              [24.32, 47.905],
              [24.285, 47.885],
              [24.23, 47.875],
              [24.205, 47.88],
              [24.195, 47.895],
              [24.145, 47.89],
              [24.1, 47.895],
              [24.07, 47.93],
              [24.05, 47.935],
              [24.02, 47.93],
              [24.01, 47.945],
              [23.965, 47.94],
              [23.935, 47.925],
              [23.89, 47.925],
              [23.865, 47.91],
              [23.84, 47.92],
              [23.82, 47.94],
              [23.81, 47.965],
              [23.785, 47.965],
              [23.775, 47.975],
              [23.65, 47.965],
              [23.625, 47.985],
              [23.54, 47.99],
              [23.525, 47.975],
              [23.52, 47.955],
              [23.51, 47.95],
              [23.45, 47.955],
              [23.43, 47.97],
              [23.405, 47.97],
              [23.385, 47.985],
              [23.365, 47.985],
              [23.35, 48],
              [23.325, 48],
              [23.31, 48.015],
              [23.31, 48.025],
              [23.275, 48.03],
              [23.255, 48.06],
              [23.26, 48.065],
              [23.255, 48.075],
              [23.25, 48.07],
              [23.19, 48.075],
              [23.165, 48.095],
              [23.13, 48.06],
              [23.13, 48.03],
              [23.105, 47.99],
              [23.095, 47.985],
              [23.07, 47.99],
              [23.03, 47.97],
              [22.99, 47.975],
              [22.96, 47.99],
              [22.97, 47.97],
              [22.96, 47.95],
              [22.925, 47.935],
              [22.885, 47.935],
              [22.82, 47.975],
              [22.82, 48.005],
              [22.855, 48.04],
              [22.84, 48.05],
              [22.84, 48.06],
              [22.82, 48.065],
              [22.81, 48.085],
              [22.795, 48.085],
              [22.785, 48.095],
              [22.755, 48.09],
              [22.75, 48.1],
              [22.72, 48.095],
              [22.675, 48.07],
              [22.59, 48.085],
              [22.57, 48.1],
              [22.57, 48.14],
              [22.54, 48.175],
              [22.54, 48.19],
              [22.515, 48.195],
              [22.48, 48.23],
              [22.455, 48.22],
              [22.415, 48.23],
              [22.395, 48.215],
              [22.365, 48.22],
              [22.35, 48.235],
              [22.35, 48.245],
              [22.32, 48.27],
              [22.32, 48.285],
              [22.3, 48.305],
              [22.29, 48.34],
              [22.255, 48.345],
              [22.24, 48.365],
              [22.22, 48.375],
              [22.22, 48.395],
              [22.205, 48.405],
              [22.165, 48.385],
              [22.135, 48.385],
              [22.115, 48.415],
              [22.12, 48.43],
            ],
          ],
        ],
      },
    },
  ],
};

function computeBBox(features) {
  let minX = Infinity,
    minY = Infinity,
    maxX = -Infinity,
    maxY = -Infinity;
  features.forEach((f) => {
    const coords = f.geometry.coordinates;
    coords.forEach((polyArray) => {
      polyArray.forEach((ring) => {
        ring.forEach(([lon, lat]) => {
          minX = Math.min(minX, lon);
          minY = Math.min(minY, lat);
          maxX = Math.max(maxX, lon);
          maxY = Math.max(maxY, lat);
        });
      });
    });
  });
  return { minX, minY, maxX, maxY };
}

function lonLatToXY(lon, lat, bbox, width, height, padding = 20) {
  const { minX, minY, maxX, maxY } = bbox;
  const geoW = maxX - minX;
  const geoH = maxY - minY;
  const scaleX = (width - padding * 2) / geoW;
  const scaleY = (height - padding * 2) / geoH;
  const scale = Math.min(scaleX, scaleY);
  const offsetX = (width - scale * geoW) / 2;
  const offsetY = (height - scale * geoH) / 2;
  const x = offsetX + (lon - minX) * scale;
  const y = offsetY + (maxY - lat) * scale;
  return [x, y];
}

export default function Map({
  width = 800,
  height = 500,
  cities = [
    { id: 1, name: 'Канків', lat: 48.14, lng: 23.05 },
    { id: 2, name: 'Косино', lat: 48.33, lng: 22.69 },
    { id: 3, name: 'Синевир', lat: 48.62, lng: 23.56 },
  ],
  onCityClick = (id) => console.log('city', id),
  onRegionClick = (name) => console.log('region', name),
}) {
  const bbox = useMemo(() => computeBBox(zakarpattiaGeoJson.features), []);

  const polygons = useMemo(() => {
    const arr = [];
    zakarpattiaGeoJson.features.forEach((f, fi) => {
      const coordsMulti = f.geometry.coordinates;
      coordsMulti.forEach((polyArray, pIndex) => {
        polyArray.forEach((ring, rIndex) => {
          const d = ring
            .map(([lon, lat], i) => {
              const [x, y] = lonLatToXY(lon, lat, bbox, width, height, 20);
              return `${i === 0 ? 'M' : 'L'} ${x.toFixed(2)} ${y.toFixed(2)}`;
            })
            .join(' ');
          arr.push({
            d: d + ' Z',
            properties: f.properties,
            featureIndex: fi,
            polyIndex: pIndex,
            ringIndex: rIndex,
          });
        });
      });
    });
    return arr;
  }, [bbox, width, height]);

  const cityPoints = useMemo(() => {
    return cities.map((c) => {
      const [x, y] = lonLatToXY(c.lng, c.lat, bbox, width, height, 20);
      return { ...c, x, y };
    });
  }, [cities, bbox, width, height]);

  return (
    <svg
      width={width}
      height={height}
      viewBox={`0 0 ${width} ${height}`}
      role="img"
      aria-label="Карта Закарпатської області"
      style={{ display: 'block', margin: '0 auto' }}
    >
      <rect width="100%" height="100%" fill="#b38e58" rx="8" />
      <g>
        {polygons.map((p, i) => (
          <path
            key={`${i}-${p.featureIndex}-${p.polyIndex}-${p.ringIndex}`}
            d={p.d}
            fill={'#314b10'}
            strokeWidth={1}
            onClick={() => onRegionClick && onRegionClick(p.properties.name)}
            style={{ cursor: 'pointer' }}
          />
        ))}
      </g>

      <g>
        {cityPoints.map((c) => (
          <g
            key={c.id}
            transform={`translate(${c.x}, ${c.y})`}
            style={{ cursor: 'pointer' }}
            onClick={() => onCityClick && onCityClick(c.id)}
          >
            <circle r={6} fill="#b38e58" stroke="#fff" strokeWidth={1.5} />
            <text x={10} y={4} fontSize={12} fill="#ffff">
              {c.name}
            </text>
          </g>
        ))}
      </g>
    </svg>
  );
}
